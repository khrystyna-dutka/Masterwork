// server.js - Ğ“Ğ¾Ğ»Ğ¾Ğ²Ğ½Ğ¸Ğ¹ Ñ„Ğ°Ğ¹Ğ» ÑĞµÑ€Ğ²ĞµÑ€Ğ°

require('dotenv').config();
const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const morgan = require('morgan');

const app = express();

// ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ±ĞµĞ·Ğ¿ĞµĞºĞ¸
app.use(helmet());

// CORS Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ
const corsOptions = {
  origin: process.env.FRONTEND_URL || 'http://localhost:3000',
  credentials: true,
  optionsSuccessStatus: 200
};
app.use(cors(corsOptions));

// Ğ›Ğ¾Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ñ–Ğ²
if (process.env.NODE_ENV === 'development') {
  app.use(morgan('dev'));
}

// ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ JSON
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ–Ğ²
const authRoutes = require('./routes/authRoutes');

// Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ¸Ğ¹ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚
app.get('/', (req, res) => {
  res.json({
    success: true,
    message: 'EcoLviv API Ğ¿Ñ€Ğ°Ñ†ÑÑ” ÑƒÑĞ¿Ñ–ÑˆĞ½Ğ¾! ğŸŒ±',
    version: '1.0.0',
    timestamp: new Date().toISOString()
  });
});

// Health check
app.get('/health', (req, res) => {
  res.json({
    status: 'OK',
    uptime: process.uptime(),
    timestamp: new Date().toISOString()
  });
});

// API Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¸
app.use('/api/auth', authRoutes);

// ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° 404
app.use((req, res) => {
  res.status(404).json({
    success: false,
    message: 'ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚ Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾'
  });
});

// Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ° Ğ¾Ğ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ¿Ğ¾Ğ¼Ğ¸Ğ»Ğ¾Ğº
app.use((err, req, res, next) => {
  console.error('Error:', err);
  
  res.status(err.status || 500).json({
    success: false,
    message: err.message || 'Ğ’Ğ½ÑƒÑ‚Ñ€Ñ–ÑˆĞ½Ñ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°',
    ...(process.env.NODE_ENV === 'development' && { stack: err.stack })
  });
});

// Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²ĞµÑ€Ğ°
const PORT = process.env.PORT || 5000;

app.listen(PORT, () => {
  console.log('='.repeat(50));
  console.log(`ğŸŒ± EcoLviv Backend Server`);
  console.log(`ğŸ“¡ Ğ ĞµĞ¶Ğ¸Ğ¼: ${process.env.NODE_ENV || 'development'}`);
  console.log(`ğŸš€ Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾ Ğ½Ğ° Ğ¿Ğ¾Ñ€Ñ‚Ñƒ ${PORT}`);
  console.log(`ğŸ”— URL: http://localhost:${PORT}`);
  console.log(`â° Ğ§Ğ°Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºÑƒ: ${new Date().toLocaleString('uk-UA')}`);
  console.log('='.repeat(50));
});

module.exports = app;